---
import Layout from '../layouts/Layout.astro';
import type { Digest } from '../types/digest';
import fs from 'node:fs';
import path from 'node:path';

// Read all digest JSON files from outputs/web
const digestsDir = path.resolve('../outputs/web');
const files = fs.existsSync(digestsDir)
  ? fs.readdirSync(digestsDir).filter(f => f.endsWith('.json') && f !== 'latest.json' && f !== 'bookmarks.json')
  : [];

interface DigestSummary {
  digest_id: string;
  project: string;
  story_count: number;
  generated_at: string;
  filename: string;
}

const digests: DigestSummary[] = files.map(filename => {
  const content = fs.readFileSync(path.join(digestsDir, filename), 'utf-8');
  const data: Digest = JSON.parse(content);
  return {
    digest_id: data.digest_id,
    project: data.project,
    story_count: data.story_count,
    generated_at: data.generated_at,
    filename: filename.replace('.json', ''),
  };
}).sort((a, b) => b.generated_at.localeCompare(a.generated_at));

const formatDate = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};
---

<Layout title="Digest Viewer - All Digests">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Content Digests</h1>
    <p class="text-gray-600">AI-curated content from Reddit and Hacker News</p>
  </div>

  {digests.length === 0 ? (
    <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
      <p class="text-gray-500">No digests found yet.</p>
      <p class="text-sm text-gray-400 mt-2">
        Run <code class="bg-gray-100 px-1 rounded">./reddit-analyzer digest --format json</code> to generate one.
      </p>
    </div>
  ) : (
    <div class="space-y-4">
      {digests.map((digest) => (
        <a
          href={`/digest/${digest.filename}`}
          class="block bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md hover:border-blue-300 transition-all"
        >
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 mb-1">
                {formatDate(digest.generated_at)}
              </h2>
              <p class="text-sm text-gray-500">
                Project: <span class="font-medium text-gray-700">{digest.project}</span>
              </p>
            </div>
            <div class="text-right">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                {digest.story_count} stories
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>
  )}
</Layout>
