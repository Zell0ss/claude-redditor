---
import Layout from '../layouts/Layout.astro';
import type { Digest } from '../types/digest';
import fs from 'node:fs';
import path from 'node:path';

// Read all digest JSON files from outputs/web
const digestsDir = path.resolve('../outputs/web');
const files = fs.existsSync(digestsDir)
  ? fs.readdirSync(digestsDir).filter(f => f.endsWith('.json') && f !== 'latest.json' && f !== 'bookmarks.json')
  : [];

interface DigestSummary {
  digest_id: string;
  project: string;
  story_count: number;
  generated_at: string;
  filename: string;
}

const digests: DigestSummary[] = files.map(filename => {
  const content = fs.readFileSync(path.join(digestsDir, filename), 'utf-8');
  const data: Digest = JSON.parse(content);
  return {
    digest_id: data.digest_id,
    project: data.project,
    story_count: data.story_count,
    generated_at: data.generated_at,
    filename: filename.replace('.json', ''),
  };
}).sort((a, b) => b.generated_at.localeCompare(a.generated_at));

const formatDate = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};
---

<Layout title="Claude Gazette - AI-Curated Content Digests">
  <!-- Hero Section -->
  <div class="mb-8 flex items-center gap-6">
    <img src="/claude/1.png" alt="Claude mascot" class="w-20 h-20" />
    <div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-400 to-cyan-500 bg-clip-text text-transparent mb-2">
        Claude Gazette
      </h1>
      <p class="text-slate-300">Your AI-curated digest of signal from Reddit and Hacker News</p>
    </div>
  </div>

  {digests.length === 0 ? (
    <div class="bg-navy-800 rounded-lg border border-navy-600 p-8 text-center">
      <p class="text-slate-400">No digests found yet.</p>
      <p class="text-sm text-slate-500 mt-2">
        Run <code class="bg-navy-700 px-2 py-1 rounded text-cyan-400">./reddit-analyzer digest --format json</code> to generate one.
      </p>
    </div>
  ) : (
    <div class="space-y-4">
      {digests.map((digest) => (
        <a
          href={`/digest/${digest.filename}`}
          class="block bg-navy-800 rounded-lg border border-navy-600 p-6 hover:border-cyan-600 hover:shadow-[0_0_20px_rgba(0,212,255,0.3)] transition-all"
        >
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-semibold text-slate-100 mb-1">
                {formatDate(digest.generated_at)}
              </h2>
              <p class="text-sm text-slate-400">
                Project: <span class="font-medium text-cyan-400">{digest.project}</span>
              </p>
            </div>
            <div class="text-right">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-cyan-500/20 text-cyan-300 border border-cyan-500/50">
                {digest.story_count} stories
              </span>
            </div>
          </div>
        </a>
      ))}
    </div>
  )}
</Layout>
