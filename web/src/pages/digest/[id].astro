---
import Layout from '../../layouts/Layout.astro';
import StoryCard from '../../components/StoryCard.astro';
import type { Digest } from '../../types/digest';
import fs from 'node:fs';
import path from 'node:path';

export async function getStaticPaths() {
  const digestsDir = path.resolve('../outputs/web');

  if (!fs.existsSync(digestsDir)) {
    return [];
  }

  const files = fs.readdirSync(digestsDir)
    .filter(f => f.endsWith('.json') && f !== 'latest.json' && f !== 'bookmarks.json');

  return files.map(filename => ({
    params: { id: filename.replace('.json', '') },
  }));
}

const { id } = Astro.params;
const digestPath = path.resolve(`../outputs/web/${id}.json`);

let digest: Digest | null = null;
if (fs.existsSync(digestPath)) {
  const content = fs.readFileSync(digestPath, 'utf-8');
  digest = JSON.parse(content);
}

const formatDate = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

const formatTime = (dateStr: string): string => {
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit',
  });
};
---

<Layout title={digest ? `Digest - ${formatDate(digest.generated_at)}` : 'Digest Not Found'}>
  {!digest ? (
    <div class="bg-navy-800 rounded-lg border border-navy-600 p-8 text-center">
      <p class="text-slate-400 text-lg">Digest not found</p>
      <a href="/" class="text-cyan-400 hover:text-cyan-300 mt-4 inline-flex items-center gap-2 transition-colors group">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="transition-transform group-hover:scale-110">
          <rect x="0.5" y="0.5" width="15" height="15" stroke="currentColor" stroke-width="1.5" rx="2"/>
          <path d="M4.5 4.5L11.5 11.5M11.5 4.5L4.5 11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <span>Back to all digests</span>
      </a>
    </div>
  ) : (
    <>
      <div class="mb-8">
        <a href="/" class="inline-flex items-center gap-2 text-cyan-400 hover:text-cyan-300 text-sm mb-4 transition-colors group">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" class="transition-transform group-hover:scale-110">
            <rect x="0.5" y="0.5" width="15" height="15" stroke="currentColor" stroke-width="1.5" rx="2"/>
            <path d="M4.5 4.5L11.5 11.5M11.5 4.5L4.5 11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span>Back to all digests</span>
        </a>

        <div class="flex items-center gap-4 mb-4">
          <img src="/claude/1.png" alt="Claude" class="w-16 h-16" />
          <div>
            <h1 class="text-3xl font-bold text-slate-100 mb-2">
              {formatDate(digest.generated_at)}
            </h1>

            <div class="flex flex-wrap items-center gap-4 text-sm text-slate-400">
              <span>Project: <span class="font-medium text-cyan-400">{digest.project}</span></span>
              <span>Generated at {formatTime(digest.generated_at)}</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-cyan-500/20 text-cyan-300 border border-cyan-500/50">
                {digest.story_count} stories
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-4">
        {digest.stories.map((story) => (
          <StoryCard story={story} showReasoning={true} />
        ))}
      </div>
    </>
  )}
</Layout>
